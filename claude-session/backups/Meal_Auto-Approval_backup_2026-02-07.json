[{"id":"YrTF0PRPsSCr81fU","name":"Meal Auto-Approval","active":1,"nodes":"[{\"parameters\":{\"rule\":{\"interval\":[{\"triggerAtHour\":14}]}},\"id\":\"31b642f5-6fd1-4953-be02-91f1c8772463\",\"name\":\"Schedule Trigger\",\"type\":\"n8n-nodes-base.scheduleTrigger\",\"typeVersion\":1.2,\"position\":[-880,112]},{\"parameters\":{\"url\":\"https://family-hub-dashboard-default-rtdb.firebaseio.com/meals.json\",\"authentication\":\"genericCredentialType\",\"genericAuthType\":\"httpQueryAuth\",\"options\":{}},\"id\":\"8226b937-2a1f-4fff-8b85-40fee0211d6f\",\"name\":\"Read Firebase Meals\",\"type\":\"n8n-nodes-base.httpRequest\",\"typeVersion\":4.2,\"position\":[-656,112],\"credentials\":{\"httpQueryAuth\":{\"id\":\"jOtWdsKTauV30mbJ\",\"name\":\"Firebase Database Secret\"}}},{\"parameters\":{\"jsCode\":\"const meals = $input.first().json;\\n\\n// Check if any meals are still pending\\nconst days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];\\nconst pendingMeals = [];\\n\\nfor (const day of days) {\\n  if (meals[day] && meals[day].status === 'pending') {\\n    pendingMeals.push(day);\\n  }\\n}\\n\\nif (pendingMeals.length === 0) {\\n  // No pending meals, skip auto-approval\\n  return {\\n    json: {\\n      hasPending: false,\\n      message: 'No pending meals found. All meals already approved or rejected.'\\n    }\\n  };\\n}\\n\\n// Has pending meals, proceed with auto-approval\\nreturn {\\n  json: {\\n    hasPending: true,\\n    pendingDays: pendingMeals,\\n    message: `Auto-approving ${pendingMeals.length} pending meal(s): ${pendingMeals.join(', ')}`\\n  }\\n};\"},\"id\":\"15f6c874-6e9a-479b-bec5-e64a5b6cd353\",\"name\":\"Check for Pending\",\"type\":\"n8n-nodes-base.code\",\"typeVersion\":2,\"position\":[-432,112]},{\"parameters\":{\"conditions\":{\"options\":{\"caseSensitive\":true,\"leftValue\":\"\",\"typeValidation\":\"strict\"},\"conditions\":[{\"leftValue\":\"={{ $json.hasPending }}\",\"rightValue\":true,\"operator\":{\"type\":\"boolean\",\"operation\":\"equals\"}}],\"combinator\":\"and\"},\"options\":{}},\"id\":\"bf0aec34-ccfc-414d-80a3-56ac0fdf3594\",\"name\":\"If Has Pending\",\"type\":\"n8n-nodes-base.if\",\"typeVersion\":2,\"position\":[-208,112]},{\"parameters\":{\"jsCode\":\"const pendingDays = $input.first().json.pendingDays;\\n\\n// Build updates for each pending day\\nconst updates = {};\\nfor (const day of pendingDays) {\\n  updates[`${day}/status`] = 'approved';\\n}\\n\\nreturn {\\n  json: {\\n    updates,\\n    pendingDays\\n  }\\n};\"},\"id\":\"c4da4aac-6ec1-4795-8e45-6e7356aceea1\",\"name\":\"Prepare Updates\",\"type\":\"n8n-nodes-base.code\",\"typeVersion\":2,\"position\":[16,16]},{\"parameters\":{\"method\":\"PATCH\",\"url\":\"https://family-hub-dashboard-default-rtdb.firebaseio.com/meals.json\",\"authentication\":\"genericCredentialType\",\"genericAuthType\":\"httpQueryAuth\",\"sendBody\":true,\"specifyBody\":\"json\",\"jsonBody\":\"={{ JSON.stringify($json.updates) }}\",\"options\":{}},\"id\":\"0af19d12-2a81-46e4-8a99-d3c7ae36558b\",\"name\":\"Update to Approved\",\"type\":\"n8n-nodes-base.httpRequest\",\"typeVersion\":4.2,\"position\":[240,16],\"credentials\":{\"httpQueryAuth\":{\"id\":\"jOtWdsKTauV30mbJ\",\"name\":\"Firebase Database Secret\"}}},{\"parameters\":{\"jsCode\":\"const pendingDays = $('Prepare Updates').first().json.pendingDays;\\nconst dayCount = pendingDays.length;\\n\\nconst message = dayCount === 1 \\n  ? `ðŸ¤– Auto-approved ${pendingDays[0]}'s meal (no response received by 2pm)`\\n  : `ðŸ¤– Auto-approved ${dayCount} meals (no response received by 2pm): ${pendingDays.join(', ')}`;\\n\\nreturn {\\n  json: {\\n    text: message\\n  }\\n};\"},\"id\":\"e901cfc4-7f98-4c54-ba19-592fa16d0762\",\"name\":\"Build Slack Message\",\"type\":\"n8n-nodes-base.code\",\"typeVersion\":2,\"position\":[464,16]},{\"parameters\":{\"method\":\"POST\",\"url\":\"https://slack.com/api/chat.postMessage\",\"authentication\":\"genericCredentialType\",\"genericAuthType\":\"httpHeaderAuth\",\"sendBody\":true,\"specifyBody\":\"json\",\"jsonBody\":\"={{ JSON.stringify({\\n  channel: 'C0A393YK0QZ',\\n  text: $json.text\\n}) }}\",\"options\":{}},\"id\":\"b9e04d80-6e5a-41a0-b5c3-19c73073db7b\",\"name\":\"Post to Slack\",\"type\":\"n8n-nodes-base.httpRequest\",\"typeVersion\":4.2,\"position\":[688,16],\"credentials\":{\"httpHeaderAuth\":{\"id\":\"bZVxYcuUFrhDW3da\",\"name\":\"Slack Bot Token\"}}},{\"parameters\":{\"jsCode\":\"// If no pending meals, just log that we checked\\nreturn {\\n  json: {\\n    message: 'Auto-approval check completed - no pending meals found'\\n  }\\n};\"},\"id\":\"78172064-f0fc-421d-8de8-098c23b82d06\",\"name\":\"No Action Needed\",\"type\":\"n8n-nodes-base.code\",\"typeVersion\":2,\"position\":[16,208]},{\"parameters\":{\"url\":\"https://family-hub-dashboard-default-rtdb.firebaseio.com/groceryItems.json\",\"authentication\":\"genericCredentialType\",\"genericAuthType\":\"httpQueryAuth\",\"options\":{}},\"id\":\"936977e0-90ca-44cb-bbe1-ef793f02bf4d\",\"name\":\"Read Current Shopping List\",\"type\":\"n8n-nodes-base.httpRequest\",\"typeVersion\":4.2,\"position\":[912,16],\"credentials\":{\"httpQueryAuth\":{\"id\":\"jOtWdsKTauV30mbJ\",\"name\":\"Firebase Database Secret\"}}},{\"parameters\":{\"url\":\"https://family-hub-dashboard-default-rtdb.firebaseio.com/meals.json\",\"authentication\":\"genericCredentialType\",\"genericAuthType\":\"httpQueryAuth\",\"options\":{}},\"id\":\"112b022c-5a88-447a-9f1b-e30e53558d4d\",\"name\":\"Read Approved Meals\",\"type\":\"n8n-nodes-base.httpRequest\",\"typeVersion\":4.2,\"position\":[1136,96],\"credentials\":{\"httpQueryAuth\":{\"id\":\"jOtWdsKTauV30mbJ\",\"name\":\"Firebase Database Secret\"}}},{\"parameters\":{\"authentication\":\"serviceAccount\",\"documentId\":{\"__rl\":true,\"value\":\"1Vjd_jXX31GFPtddHitbGBh_jlIDsTy6pYvtlopcbc0w\",\"mode\":\"list\",\"cachedResultName\":\"Meal Planning Data\"},\"sheetName\":{\"__rl\":true,\"value\":1904280104,\"mode\":\"list\",\"cachedResultName\":\"Pantry Items\"},\"options\":{}},\"id\":\"a4641f3c-946a-48af-af37-bdebbb32b59a\",\"name\":\"Read Pantry Items\",\"type\":\"n8n-nodes-base.googleSheets\",\"typeVersion\":4,\"position\":[1360,160],\"credentials\":{\"googleApi\":{\"id\":\"n1rhMvRIp4MBbbbS\",\"name\":\"Google Service Account account\"}}},{\"parameters\":{\"mode\":\"combine\",\"combineBy\":\"combineByPosition\",\"numberInputs\":3,\"options\":{}},\"id\":\"7567071f-c583-4ac5-a04b-4df3c2d1489f\",\"name\":\"Merge Shopping Data\",\"type\":\"n8n-nodes-base.merge\",\"typeVersion\":3.2,\"position\":[1584,0]},{\"parameters\":{\"jsCode\":\"const mergedData = $input.all()[0].json;\\n\\n// Function to clean ingredient text\\nfunction cleanIngredient(ingredient) {\\n  let cleaned = ingredient.toLowerCase().trim();\\n  cleaned = cleaned.replace(/^[\\\\d\\\\/\\\\-\\\\.\\\\s]+/, '');\\n  \\n  const units = [\\n    'cup', 'cups', 'tsp', 'tbsp', 'tablespoon', 'tablespoons', 'teaspoon', 'teaspoons',\\n    'lb', 'lbs', 'pound', 'pounds', 'oz', 'ounce', 'ounces',\\n    'can', 'cans', 'jar', 'jars', 'package', 'packages',\\n    'large', 'medium', 'small', 'whole', 'head', 'bunch', 'clove', 'cloves',\\n    'diced', 'chopped', 'minced', 'sliced', 'grated', 'shredded',\\n    'fresh', 'dried', 'ground', 'cooked', 'peeled', 'deveined'\\n  ];\\n  \\n  for (const unit of units) {\\n    const regex = new RegExp(`^${unit}\\\\\\\\s+`, 'i');\\n    cleaned = cleaned.replace(regex, '');\\n  }\\n  \\n  cleaned = cleaned.replace(/\\\\s+/g, ' ').trim();\\n  return cleaned.charAt(0).toUpperCase() + cleaned.slice(1);\\n}\\n\\n// Identify meal days\\nconst mealDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];\\n\\n// Extract existing shopping list items\\nconst existingItems = Object.values(mergedData)\\n  .filter(item => item && typeof item === 'object' && item.id)\\n  .map(item => item.text.toLowerCase().trim());\\n\\n// HARDCODED PANTRY ITEMS (from Google Sheet)\\nconst pantryItems = [\\n  'olive oil', 'salt', 'pepper', 'vegetable oil', 'white vinegar',\\n  'apple cider vinegar', 'red wine vinegar', 'balsamic vinegar', 'rice vinegar',\\n  'butter', 'dijon mustard', 'whole grain mustard', 'mayo', 'honey',\\n  'ketchup', 'garlic powder', 'onion powder', 'flour', 'sugar',\\n  'baking soda', 'baking powder', 'corn starch', 'hot sauce', 'paprika',\\n  'cumin', 'chili pepper', 'worcestershire sauce', 'brown sugar',\\n  'chicken broth', 'soy sauce', 'bay leaves', 'cinnamon', 'nutmeg',\\n  'cloves', 'turmeric', 'ginger'\\n].map(item => item.toLowerCase().trim());\\n\\n// Extract ingredients from approved meals\\nlet allIngredients = [];\\nfor (const day of mealDays) {\\n  const meal = mergedData[day];\\n  if (meal && meal.status === 'approved' && meal.ingredients) {\\n    const cleanedIngredients = meal.ingredients.map(ing => cleanIngredient(ing));\\n    allIngredients = allIngredients.concat(cleanedIngredients);\\n  }\\n}\\n\\n// Filter out pantry items - use whole word matching\\nlet afterPantryFilter = [];\\nlet pantryFiltered = 0;\\nfor (const ingredient of allIngredients) {\\n  const ingredientLower = ingredient.toLowerCase();\\n  \\n  // Check if ingredient EXACTLY matches a pantry item (whole word/phrase)\\n  const isPantryItem = pantryItems.some(pantry => {\\n    // Exact match\\n    if (ingredientLower === pantry) return true;\\n    \\n    // Word boundary match - pantry item must be a complete word\\n    const regex = new RegExp(`\\\\\\\\b${pantry}\\\\\\\\b`, 'i');\\n    return regex.test(ingredientLower);\\n  });\\n  \\n  if (!isPantryItem) {\\n    afterPantryFilter.push(ingredient);\\n  } else {\\n    pantryFiltered++;\\n  }\\n}\\n\\n// Remove duplicates\\nconst uniqueIngredients = [...new Set(afterPantryFilter)];\\n\\n// Filter out existing shopping list items\\nlet finalIngredients = [];\\nlet duplicatesSkipped = 0;\\nfor (const ingredient of uniqueIngredients) {\\n  const ingredientLower = ingredient.toLowerCase();\\n  const isDuplicate = existingItems.some(existing => \\n    ingredientLower.includes(existing) || existing.includes(ingredientLower)\\n  );\\n  \\n  if (!isDuplicate) {\\n    finalIngredients.push(ingredient);\\n  } else {\\n    duplicatesSkipped++;\\n  }\\n}\\n\\nreturn {\\n  ingredients: finalIngredients,\\n  totalExtracted: allIngredients.length,\\n  afterFiltering: finalIngredients.length,\\n  pantryItemsFiltered: pantryFiltered,\\n  duplicatesSkipped: duplicatesSkipped,\\n  pantryItemsFound: pantryItems.length\\n};\"},\"id\":\"c6e5e0ce-0563-4c3b-b53b-994b0eac0bf4\",\"name\":\"Extract and Filter Ingredients\",\"type\":\"n8n-nodes-base.code\",\"typeVersion\":2,\"position\":[1808,16]},{\"parameters\":{\"jsCode\":\"const { ingredients } = $input.first().json;\\n\\nif (ingredients.length === 0) {\\n  return {\\n    json: {\\n      newItems: {},\\n      count: 0,\\n      message: 'No new items to add (all ingredients filtered as pantry or duplicates)'\\n    }\\n  };\\n}\\n\\n// Decorative options\\nconst bgColors = ['#5398cb', '#e85d75', '#f4a261', '#2a9d8f', '#e76f51', '#8ab17d'];\\nconst bgPatterns = [\\n  '/watermarks/Bowl.svg',\\n  '/watermarks/Cheese.svg', \\n  '/watermarks/Lemons.svg',\\n  '/watermarks/Strawberry.svg'\\n];\\n\\n// Build Firebase objects\\nconst newItems = {};\\nconst timestamp = Date.now();\\n\\nfor (let i = 0; i < ingredients.length; i++) {\\n  const ingredient = ingredients[i];\\n  const itemId = timestamp + i;\\n  \\n  // Random decoration (30% chance of special styling)\\n  const isSpecial = Math.random() < 0.3;\\n  \\n  const item = {\\n    id: itemId,\\n    text: ingredient,\\n    checked: false,\\n    addedAt: itemId,\\n    done: false,\\n    special: isSpecial,\\n    bgColor: isSpecial ? bgColors[Math.floor(Math.random() * bgColors.length)] : null,\\n    bgPattern: isSpecial ? bgPatterns[Math.floor(Math.random() * bgPatterns.length)] : null\\n  };\\n  \\n  // Firebase auto-generates keys, so we'll use POST which creates them\\n  newItems[`item_${i}`] = item;\\n}\\n\\nreturn {\\n  json: {\\n    newItems,\\n    count: ingredients.length,\\n    itemsToAdd: Object.values(newItems)\\n  }\\n};\"},\"id\":\"8d5076a5-6373-457d-8d2b-ffdfefeb11ad\",\"name\":\"Build Grocery Items\",\"type\":\"n8n-nodes-base.code\",\"typeVersion\":2,\"position\":[2032,16]},{\"parameters\":{\"method\":\"PATCH\",\"url\":\"https://family-hub-dashboard-default-rtdb.firebaseio.com/groceryItems.json\",\"authentication\":\"genericCredentialType\",\"genericAuthType\":\"httpQueryAuth\",\"sendBody\":true,\"specifyBody\":\"json\",\"jsonBody\":\"={{ JSON.stringify($json.newItems) }}\",\"options\":{}},\"id\":\"24af02c7-f984-44b4-8945-b5ad3629fcde\",\"name\":\"Save to Firebase\",\"type\":\"n8n-nodes-base.httpRequest\",\"typeVersion\":4.2,\"position\":[2256,16],\"credentials\":{\"httpQueryAuth\":{\"id\":\"jOtWdsKTauV30mbJ\",\"name\":\"Firebase Database Secret\"}}},{\"parameters\":{\"jsCode\":\"const count = $('Build Grocery Items').first().json.count;\\n\\nif (count === 0) {\\n  return {\\n    json: {\\n      text: 'ðŸ›’ No new ingredients to add to shopping list (all were pantry staples or duplicates)'\\n    }\\n  };\\n}\\n\\nconst message = count === 1 \\n  ? `ðŸ›’ Added 1 ingredient to shopping list`\\n  : `ðŸ›’ Added ${count} ingredients to shopping list`;\\n\\nreturn {\\n  json: {\\n    text: message\\n  }\\n};\"},\"id\":\"419c055f-4df5-4cb4-ac70-445ab67bf680\",\"name\":\"Build Shopping Confirmation\",\"type\":\"n8n-nodes-base.code\",\"typeVersion\":2,\"position\":[2480,16]},{\"parameters\":{\"method\":\"POST\",\"url\":\"https://slack.com/api/chat.postMessage\",\"authentication\":\"genericCredentialType\",\"genericAuthType\":\"httpHeaderAuth\",\"sendBody\":true,\"specifyBody\":\"json\",\"jsonBody\":\"={{ JSON.stringify({\\n  channel: 'C0A393YK0QZ',\\n  text: $json.text\\n}) }}\",\"options\":{}},\"id\":\"3ffc2c26-820d-4b7e-b35e-c780348c1e03\",\"name\":\"Post Shopping Confirmation\",\"type\":\"n8n-nodes-base.httpRequest\",\"typeVersion\":4.2,\"position\":[2704,16],\"credentials\":{\"httpHeaderAuth\":{\"id\":\"bZVxYcuUFrhDW3da\",\"name\":\"Slack Bot Token\"}}}]","connections":"{\"Schedule Trigger\":{\"main\":[[{\"node\":\"Read Firebase Meals\",\"type\":\"main\",\"index\":0}]]},\"Read Firebase Meals\":{\"main\":[[{\"node\":\"Check for Pending\",\"type\":\"main\",\"index\":0}]]},\"Check for Pending\":{\"main\":[[{\"node\":\"If Has Pending\",\"type\":\"main\",\"index\":0}]]},\"If Has Pending\":{\"main\":[[{\"node\":\"Prepare Updates\",\"type\":\"main\",\"index\":0}],[{\"node\":\"No Action Needed\",\"type\":\"main\",\"index\":0}]]},\"Prepare Updates\":{\"main\":[[{\"node\":\"Update to Approved\",\"type\":\"main\",\"index\":0}]]},\"Update to Approved\":{\"main\":[[{\"node\":\"Build Slack Message\",\"type\":\"main\",\"index\":0}]]},\"Build Slack Message\":{\"main\":[[{\"node\":\"Post to Slack\",\"type\":\"main\",\"index\":0}]]},\"Read Current Shopping List\":{\"main\":[[{\"node\":\"Read Approved Meals\",\"type\":\"main\",\"index\":0},{\"node\":\"Merge Shopping Data\",\"type\":\"main\",\"index\":0}]]},\"Read Approved Meals\":{\"main\":[[{\"node\":\"Merge Shopping Data\",\"type\":\"main\",\"index\":1},{\"node\":\"Read Pantry Items\",\"type\":\"main\",\"index\":0}]]},\"Read Pantry Items\":{\"main\":[[{\"node\":\"Merge Shopping Data\",\"type\":\"main\",\"index\":2}]]},\"Merge Shopping Data\":{\"main\":[[{\"node\":\"Extract and Filter Ingredients\",\"type\":\"main\",\"index\":0}]]},\"Extract and Filter Ingredients\":{\"main\":[[{\"node\":\"Build Grocery Items\",\"type\":\"main\",\"index\":0}]]},\"Build Grocery Items\":{\"main\":[[{\"node\":\"Save to Firebase\",\"type\":\"main\",\"index\":0}]]},\"Save to Firebase\":{\"main\":[[{\"node\":\"Build Shopping Confirmation\",\"type\":\"main\",\"index\":0}]]},\"Build Shopping Confirmation\":{\"main\":[[{\"node\":\"Post Shopping Confirmation\",\"type\":\"main\",\"index\":0}]]},\"Post to Slack\":{\"main\":[[{\"node\":\"Read Current Shopping List\",\"type\":\"main\",\"index\":0}]]},\"No Action Needed\":{\"main\":[[{\"node\":\"Read Current Shopping List\",\"type\":\"main\",\"index\":0}]]}}","settings":"{\"executionOrder\":\"v1\"}","staticData":"{\"node:Schedule Trigger\":{\"recurrenceRules\":[]}}"}]
