{
  "name": "Slack Button Handler - Phase 3 v2",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "slack-button-handler",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "slack-button-handler"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "",
        "options": {}
      },
      "id": "respond-immediately",
      "name": "Respond Immediately",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse Slack button interaction payload\n// Slack sends as form-urlencoded with a 'payload' field containing JSON\nconst inputData = $input.first().json;\n\n// Debug: log what we received\nconst debugInfo = {\n  keys: Object.keys(inputData),\n  hasBody: !!inputData.body,\n  hasPayload: !!inputData.payload,\n  bodyType: typeof inputData.body,\n  payloadType: typeof inputData.payload\n};\n\nlet payload;\n\n// Try different ways Slack might send the data\nif (inputData.payload) {\n  // Form-encoded: payload is a JSON string\n  payload = typeof inputData.payload === 'string' ? JSON.parse(inputData.payload) : inputData.payload;\n} else if (inputData.body && inputData.body.payload) {\n  // Nested in body.payload\n  payload = typeof inputData.body.payload === 'string' ? JSON.parse(inputData.body.payload) : inputData.body.payload;\n} else if (inputData.body && inputData.body.actions) {\n  // Direct JSON in body\n  payload = inputData.body;\n} else if (inputData.actions) {\n  // Direct at root level\n  payload = inputData;\n} else {\n  // Return debug info if we can't find the payload\n  return [{ json: { error: 'Could not find Slack payload', debug: debugInfo, raw: JSON.stringify(inputData).substring(0, 1000) } }];\n}\n\n// Extract action information\nconst action = payload.actions[0];\nconst actionId = action.action_id;\nconst opportunityId = action.value;\nconst actionType = actionId.split('_')[0];\n\n// Get today's date for digest lookup\nconst today = new Date().toISOString().split('T')[0];\n\n// Extract user and channel info\nconst user = payload.user.name || payload.user.id;\nconst channel = payload.channel.id;\nconst messageTs = payload.message.ts;\n\nreturn [{\n  json: {\n    action_type: actionType,\n    opportunity_id: opportunityId,\n    channel: channel,\n    message_ts: messageTs,\n    digest_date: today,\n    user: user\n  }\n}];"
      },
      "id": "parse-button-action",
      "name": "Parse Button Action",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.update",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer xoxb-9570960523936-10431921181313-gdijmNyeLV1yBrVRRxJSOEiF"
            },
            {
              "name": "Content-Type",
              "value": "application/json; charset=utf-8"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"{{ $json.channel }}\",\n  \"ts\": \"{{ $json.message_ts }}\",\n  \"text\": \"â³ Processing [{{ $json.opportunity_id }}]...\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"â³ *Processing [{{ $json.opportunity_id }}]...*\\n\\n_This may take 30-60 seconds._\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "id": "ack-processing",
      "name": "Acknowledge - Processing",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Pass through the parsed data, adding Slack response info\nconst input = $('Parse Button Action').first().json;\nconst slackResponse = $input.first().json;\n\nreturn [{\n  json: {\n    ...input,\n    ack_ok: slackResponse.ok\n  }\n}];"
      },
      "id": "merge-context",
      "name": "Merge Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "route-develop",
              "leftValue": "={{ $json.action_type }}",
              "rightValue": "develop",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "route-by-action",
      "name": "Route by Action",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "cd /opt/crewai && source venv/bin/activate && python3 catalyst.py --digest-date {{ $json.digest_date }} --opportunity {{ $json.opportunity_id }} --type plan 2>&1",
        "host": "192.168.1.18",
        "user": "root"
      },
      "id": "run-catalyst",
      "name": "Run Catalyst",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [1500, 200],
      "credentials": {
        "sshPrivateKey": {
          "id": "1",
          "name": "Container 118 SSH"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Catalyst output\nconst stdout = $input.first().json.stdout;\nconst previousData = $('Merge Context').first().json;\n\n// Extract JSON from OUTPUT START/END markers\nconst startMarker = '[Catalyst] === OUTPUT START ===';\nconst endMarker = '[Catalyst] === OUTPUT END ===';\n\nconst startIdx = stdout.indexOf(startMarker);\nconst endIdx = stdout.indexOf(endMarker);\n\nif (startIdx === -1 || endIdx === -1) {\n  return [{\n    json: {\n      ...previousData,\n      catalyst_success: false,\n      error: 'Could not find Catalyst output markers',\n      raw_output: stdout.substring(stdout.length - 500)\n    }\n  }];\n}\n\nconst jsonStr = stdout.substring(startIdx + startMarker.length, endIdx).trim();\n\ntry {\n  const catalystOutput = JSON.parse(jsonStr);\n  return [{\n    json: {\n      ...previousData,\n      catalyst_success: catalystOutput.success,\n      markdown_file: catalystOutput.markdown_file,\n      opportunity_title: catalystOutput.opportunity_title,\n      deliverable_content: catalystOutput.deliverable_content\n    }\n  }];\n} catch (e) {\n  return [{\n    json: {\n      ...previousData,\n      catalyst_success: false,\n      error: 'Failed to parse Catalyst JSON: ' + e.message,\n      raw_json: jsonStr.substring(0, 500)\n    }\n  }];\n}"
      },
      "id": "parse-catalyst-output",
      "name": "Parse Catalyst Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1750, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.update",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer xoxb-9570960523936-10431921181313-gdijmNyeLV1yBrVRRxJSOEiF"
            },
            {
              "name": "Content-Type",
              "value": "application/json; charset=utf-8"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"{{ $json.channel }}\",\n  \"ts\": \"{{ $json.message_ts }}\",\n  \"text\": \"âœ… Technical Plan generated for [{{ $json.opportunity_id }}]\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"âœ… *Technical Plan generated for [{{ $json.opportunity_id }}]*\\n\\n*{{ $json.opportunity_title }}*\\n\\nðŸ“ Check Obsidian: `_crewai-outputs/`\\n\\nFile will sync within ~15 seconds.\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "id": "update-slack-develop",
      "name": "Update Slack - Develop Success",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 200]
    },
    {
      "parameters": {
        "authentication": "privateKey",
        "command": "echo \"{{ $now.toISO() }},{{ $json.opportunity_id }},{{ $json.user }}\" >> /opt/crewai/logs/ignored_opportunities.log",
        "host": "192.168.1.18",
        "user": "root"
      },
      "id": "log-ignore-action",
      "name": "Log Ignore Action",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [1500, 400],
      "credentials": {
        "sshPrivateKey": {
          "id": "1",
          "name": "Container 118 SSH"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pass through context from Merge Context\nconst previousData = $('Merge Context').first().json;\nreturn [{ json: previousData }];"
      },
      "id": "pass-ignore-context",
      "name": "Pass Ignore Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1750, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.update",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer xoxb-9570960523936-10431921181313-gdijmNyeLV1yBrVRRxJSOEiF"
            },
            {
              "name": "Content-Type",
              "value": "application/json; charset=utf-8"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"{{ $json.channel }}\",\n  \"ts\": \"{{ $json.message_ts }}\",\n  \"text\": \"ðŸš« Opportunity [{{ $json.opportunity_id }}] marked as ignored\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"ðŸš« *[{{ $json.opportunity_id }}] marked as ignored*\\n\\n_No further action will be taken._\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "id": "update-slack-ignore",
      "name": "Update Slack - Ignored",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 400]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Respond Immediately",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond Immediately": {
      "main": [
        [
          {
            "node": "Parse Button Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Button Action": {
      "main": [
        [
          {
            "node": "Acknowledge - Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acknowledge - Processing": {
      "main": [
        [
          {
            "node": "Merge Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Context": {
      "main": [
        [
          {
            "node": "Route by Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Action": {
      "main": [
        [
          {
            "node": "Run Catalyst",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Ignore Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Catalyst": {
      "main": [
        [
          {
            "node": "Parse Catalyst Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Catalyst Output": {
      "main": [
        [
          {
            "node": "Update Slack - Develop Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Ignore Action": {
      "main": [
        [
          {
            "node": "Pass Ignore Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pass Ignore Context": {
      "main": [
        [
          {
            "node": "Update Slack - Ignored",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "errorWorkflow": "",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2026-02-05T00:00:00.000Z",
  "versionId": "2.0"
}
